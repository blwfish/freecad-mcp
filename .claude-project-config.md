# FreeCAD MCP Project Configuration

**IMPORTANT: Read this file FIRST before making changes to the project!**

## Critical Path Information

### FreeCAD Installation Paths
**YOU ARE RUNNING FREECAD 1.2-dev!**

- ✅ **CORRECT Runtime Path**: `~/Library/Application Support/FreeCAD/v1-2/Mod/AICopilot/`
- ❌ **WRONG**: `~/Library/Application Support/FreeCAD/Mod/AICopilot/` (this is for stable releases)

**Always sync to v1-2 directory!**

### Repository Structure
- **Development Worktree**: `/Users/blw/.claude-worktrees/freecad-mcp/lucid-zhukovsky/`
- **Main Repository**: `/Volumes/Additional Files/development/freecad-mcp/`
- **Active Source**: `AICopilot/` directory (not root!)
- **MCP Bridge**: `working_bridge.py` (in both worktree and main repo)

### Claude Desktop MCP Configuration
**Config file**: `~/Library/Application Support/Claude/claude_desktop_config.json`

**Note**: The config may reference `/Users/blw/freecad-mcp/` which is a symlink or old path.
The actual files are in the main repository on the external volume.

### Sync Command Template
```bash
# Sync to FreeCAD (DO THIS!)
rsync -av --delete /Users/blw/.claude-worktrees/freecad-mcp/lucid-zhukovsky/AICopilot/ ~/Library/Application\ Support/FreeCAD/v1-2/Mod/AICopilot/

# Sync to main repo
rsync -av --delete /Users/blw/.claude-worktrees/freecad-mcp/lucid-zhukovsky/AICopilot/ "/Volumes/Additional Files/development/freecad-mcp/AICopilot/"
```

## Version Management

### Current Versions (as of 2024-12-09)
- **socket_server.py**: v3.4.0
- **freecad_debug.py**: v1.1.0
- **freecad_health.py**: v1.0.1

### Version Numbering Rules
- **Major (X.0.0)**: Breaking changes, major refactors
- **Minor (3.X.0)**: New features, significant changes
- **Patch (3.4.X)**: Bug fixes, small improvements

**NEVER regress version numbers!**

### How to Update Versions
1. Check current version in git log: `git log --oneline --all -10`
2. Check `__version__` in the file you're modifying
3. Increment appropriately (don't go backwards!)
4. Update both the `__version__` variable AND the header comment

## Architecture Rules

### socket_server.py (v3.4.0)
**Size target: ~700-800 lines**

**What goes here:**
- Socket infrastructure (send/receive/framing)
- UniversalSelector class
- FreeCADSocketServer class
- Tool routing (maps to handlers)
- Debug/monitoring hooks

**What does NOT go here:**
- ❌ Operation implementations (use handlers/)
- ❌ Embedded methods like `_create_box`, `_fillet_edges`
- ❌ Any business logic that can be in a handler

### handlers/ Directory Structure
```
handlers/
├── __init__.py          # Exports all handlers
├── base.py              # BaseHandler class
├── primitives.py        # Box, cylinder, sphere, etc.
├── boolean_ops.py       # Fuse, cut, common
├── transforms.py        # Move, rotate, copy, array
├── sketch_ops.py        # Sketch creation/validation
├── partdesign_ops.py    # Pad, fillet, chamfer, holes, patterns
├── part_ops.py          # Part workbench operations
├── cam_ops.py           # CAM/Path operations
├── draft_ops.py         # Draft workbench
├── view_ops.py          # View control, screenshots
├── document_ops.py      # Document management
├── measurement_ops.py   # Measurements
└── spreadsheet_ops.py   # Spreadsheet operations
```

**Handler Rules:**
- Each handler inherits from `BaseHandler`
- Gets `server` reference for accessing `selector`
- Returns strings (success messages or error messages)
- No direct JSON encoding (server handles that)

## Common Pitfalls

### 0. Losing Fixes During Refactoring
**When rewriting code, ALWAYS check what the old code was doing right!**
- The bloated v3.0.0 had GUI queue passing (lines 456-457)
- Our clean v3.4.0 initially forgot this → crash
- **Lesson**: Compare old vs new carefully, especially for threading/GUI code

### 1. File Size Bloat
**If socket_server.py > 1000 lines, you did it wrong!**
- Don't add operations inline
- Extract to appropriate handler
- Use the routing system

### 2. Wrong Installation Path
**Always check FreeCAD version before syncing!**
```bash
# Check which version is running
ls -ld ~/Library/Application\ Support/FreeCAD/*/Mod/AICopilot
```

### 3. Version Regression
**Before setting version, check git history!**
```bash
git log --oneline --all -10 | grep -i "release\|version"
```

### 4. Duplicate Code
**Symptoms:**
- socket_server.py has methods like `_create_box`
- Handlers exist but aren't imported/used
- If/elif chains with 50+ branches

**Solution:**
- Archive the bloated file
- Write clean router (see v3.4.0)
- Use handler maps instead of if/elif

## Debug & Monitoring

### Debug Infrastructure
- **freecad_debug**: Operation logging, state capture
- **freecad_health**: Crash logging, health monitoring
- **Optional but recommended**

### Log Locations
- Debug logs: `/tmp/freecad_mcp_debug/`
- Crash logs: `/tmp/freecad_mcp_crashes/`

### Enabling Debug Mode
Debug is automatically enabled if modules are present.
Check console on startup for:
```
✅ MCP Debug infrastructure loaded
   Logs: /tmp/freecad_mcp_debug/
   Crashes: /tmp/freecad_mcp_crashes/
```

## Testing Checklist

Before marking work complete:

- [ ] `python3 -m py_compile` passes on all modified Python files
- [ ] Version number incremented (not regressed!)
- [ ] Synced to v1-2/Mod/AICopilot (not just Mod/AICopilot!)
- [ ] Synced to main repo
- [ ] socket_server.py < 1000 lines
- [ ] No embedded operation methods in socket_server.py
- [ ] Handlers properly imported and used
- [ ] Test in FreeCAD (AI Copilot workbench loads)

## Emergency Recovery

### If You Broke It
1. Check archive directory for backups:
   ```bash
   ls -lh archive/socket_server*
   ```

2. Restore last known good version:
   ```bash
   cp archive/socket_server_v3.4.0_working.py AICopilot/socket_server.py
   ```

3. Resync to FreeCAD v1-2

### Archive Naming Convention
```
archive/socket_server_vX.Y.Z_description.py
```
Example: `socket_server_v3.0.0_bloated.py`

## Resources

### Documentation
- CLAUDE.md: User-facing modal command workflow
- This file: Developer/AI configuration

### Git Workflow
- Main branch: stable releases
- Worktree: `lucid-zhukovsky` for current development
- Always commit with clear version info

---

**Last Updated**: 2024-12-09
**Current Active Version**: socket_server v3.4.0 (742 lines, handler-based)
