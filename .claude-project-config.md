# FreeCAD MCP Project Configuration

**IMPORTANT: Read this file FIRST before making changes to the project!**

## Critical Path Information

### FreeCAD Installation Paths
**YOU ARE RUNNING FREECAD 1.2-dev!**

- **CORRECT Runtime Path**: `~/Library/Application Support/FreeCAD/v1-2/Mod/AICopilot/`
- **WRONG**: `~/Library/Application Support/FreeCAD/Mod/AICopilot/` (this is for stable releases)

**Always sync to v1-2 directory!**

### Repository Structure
- **Dev Repo**: `/Volumes/Files/claude/freecad-mcp/`
- **Active Source**: `AICopilot/` directory (socket server + handlers)
- **MCP Bridge**: `working_bridge.py` (repo root, installed to `~/.freecad-mcp/`)
- **Unit Tests**: `tests/unit/` (pytest, no FreeCAD required)

### Sync Command
```bash
rsync -av --delete /Volumes/Files/claude/freecad-mcp/AICopilot/ \
  ~/Library/Application\ Support/FreeCAD/v1-2/Mod/AICopilot/
```

## Version Management

### Current Versions
- **socket_server.py**: v5.0.0
- **freecad_debug.py**: v1.1.0
- **freecad_health.py**: v1.0.1

### Version Numbering Rules
- **Major (X.0.0)**: Breaking changes, major refactors
- **Minor (5.X.0)**: New features, significant changes
- **Patch (5.0.X)**: Bug fixes, small improvements

**NEVER regress version numbers!**

## Architecture Rules

### socket_server.py (v5.0.0)
**Size target: ~700-750 lines**

**What goes here:**
- Socket infrastructure (send/receive/framing)
- FreeCADSocketServer class
- Tool routing (`_execute_tool` dispatch maps)
- `_run_on_gui_thread` / `_dispatch_to_handler` / specialized dispatchers
- `_execute_python` with AST-based expression capture
- Debug/monitoring hooks

**What does NOT go here:**
- Operation implementations (use handlers/)
- Embedded methods like `_create_box`, `_fillet_edges`
- Any business logic that can be in a handler

### handlers/ Directory Structure
```
handlers/
├── __init__.py          # Exports all handlers
├── base.py              # BaseHandler class
├── primitives.py        # Box, cylinder, sphere, etc.
├── boolean_ops.py       # Fuse, cut, common
├── transforms.py        # Move, rotate, copy, array
├── sketch_ops.py        # Sketch creation/validation
├── partdesign_ops.py    # Pad, fillet, chamfer, holes, patterns
├── part_ops.py          # Part workbench operations
├── cam_ops.py           # CAM/Path operations
├── cam_tools.py         # CAM tool definitions
├── cam_tool_controllers.py  # CAM tool controllers
├── draft_ops.py         # Draft workbench
├── view_ops.py          # View control, screenshots
├── document_ops.py      # Document management
├── measurement_ops.py   # Measurements
└── spreadsheet_ops.py   # Spreadsheet operations
```

**Handler Rules:**
- Each handler inherits from `BaseHandler`
- Gets `server` reference for accessing shared resources
- Returns strings (success messages or error messages)
- No direct JSON encoding (server handles that)

## Testing

### Unit Tests (no FreeCAD needed)
```bash
python3 -m pytest           # uses pyproject.toml testpaths
python3 -m pytest -v        # verbose
```

Covers: message framing protocol, dispatch routing, GUI thread mechanism, execute_python, command parsing.

### CI
GitHub Actions runs on push/PR: Ubuntu + macOS, Python 3.10/3.12/3.13.

### Smoke Testing (needs FreeCAD)
After syncing to FreeCAD, verify:
1. FreeCAD console shows "AI Socket Server started - Claude ready"
2. `check_freecad_connection` from Claude succeeds
3. `create_box`, `partdesign pad/fillet`, `list_objects`, `execute_python` all work

## Debug & Monitoring

### Debug Infrastructure (Optional)
- **freecad_debug**: Operation logging, state capture
- **freecad_health**: Crash logging, health monitoring
- Auto-enabled if modules present on `sys.path`

### Log Locations
- Debug logs: `/tmp/freecad_mcp_debug/`
- Crash logs: `/tmp/freecad_mcp_crashes/`

## Common Pitfalls

### 1. Wrong Installation Path
**Always check FreeCAD version before syncing!**
```bash
ls -ld ~/Library/Application\ Support/FreeCAD/*/Mod/AICopilot
```

### 2. File Size Bloat
**If socket_server.py > 800 lines, extract to a handler!**

### 3. Version Regression
**Before setting version, check git history!**

### 4. GUI Thread Safety
Operations that touch FreeCAD GUI (view, selection, some document ops) MUST run on the Qt main thread. Use `_run_on_gui_thread()` or pass the task queues to the handler.

---

**Last Updated**: 2026-02-18
**Current Active Version**: socket_server v5.0.0 (732 lines, handler-based)
